use std::marker::PhantomData;

/// An Extension to a protobuf message.
#[derive(Debug, Clone, Copy)]
pub struct Extension<M, T> {
    pub(crate) number: u32,
    pub(crate) _phantom: PhantomData<(M, T)>,
}

// TODO: This should be generated by the code generator.
impl<M, T> Extension<M, T>
where
    M: crate::Message,
    T: crate::Message + Default,
{
    pub const fn new(number: u32) -> Self {
        Self { number, _phantom: PhantomData }
    }
}

#[cfg(cpp_kernel)]
impl<M, T> Extension<M, T>
where
    M: crate::Message,
    T: crate::Message + Default,
{
    pub fn get<'a>(&self, m: crate::View<'a, M>) -> Option<crate::View<'a, T>>
    where
        crate::View<'a, M>: crate::MessageViewInterop<'a>,
        <T as crate::Proxied>::View<'a>: crate::MessageViewInterop<'a>,
    {
        crate::__internal::runtime::get_extension_message::<M, T>(m, self.number)
    }

    pub fn has<'a>(&self, m: crate::View<'a, M>) -> bool
    where
        crate::View<'a, M>: crate::MessageViewInterop<'a>,
    {
        crate::__internal::runtime::has_extension_message::<M, T>(m, self.number)
    }

    pub fn set<'a>(&self, m: crate::Mut<'a, M>, val: T)
    where
        crate::Mut<'a, M>: crate::MessageMutInterop<'a>,
        for<'b> <T as crate::Proxied>::View<'b>: crate::MessageViewInterop<'b>,
    {
        crate::__internal::runtime::set_extension_message::<M, T>(m, self.number, val)
    }
}

#[cfg(upb_kernel)]
impl<M, T> Extension<M, T>
where
    M: crate::Message + crate::__internal::runtime::AssociatedMiniTable,
    T: crate::Message + Default + crate::__internal::runtime::AssociatedMiniTable,
{
    pub fn get<'a>(&self, m: crate::View<'a, M>) -> Option<crate::View<'a, T>>
    where
        crate::View<'a, M>: crate::MessageViewInterop<'a>,
        <T as crate::Proxied>::View<'a>: crate::MessageViewInterop<'a>,
    {
        crate::__internal::runtime::get_extension_message::<M, T>(m, self.number)
    }

    pub fn has<'a>(&self, m: crate::View<'a, M>) -> bool
    where
        crate::View<'a, M>: crate::MessageViewInterop<'a>,
    {
        crate::__internal::runtime::has_extension_message::<M, T>(m, self.number)
    }

    pub fn set<'a>(&self, m: crate::Mut<'a, M>, val: T)
    where
        crate::Mut<'a, M>: crate::MessageMutInterop<'a>
            + crate::__internal::runtime::UpbGetMessagePtrMut<Msg = M>
            + crate::__internal::runtime::UpbGetArena
            + crate::__internal::runtime::UpbGetMessagePtr,
    {
        crate::__internal::runtime::set_extension_message::<M, T>(m, self.number, val)
    }
}
